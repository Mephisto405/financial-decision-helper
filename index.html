<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>간이세액 계산기</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <style>
        .container {
            margin: 20px;
        }
        input, button {
            margin-top: 10px;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>간이세액 계산기</h2>
        <label for="preTaxIncome">세전 월급 (만원):</label>
        <input type="number" id="preTaxIncome" value="200" min="77">
        <span class="warning" id="warningPreTaxIncome"></span><br>

        <label for="nonTaxableAmount">비과세액 (만원):</label>
        <input type="number" id="nonTaxableAmount" value="0" min="0">
        <span class="warning" id="warningNonTaxableAmount"></span><br>

        <label for="dependents">부양 가족 수 (본인 포함):</label>
        <input type="number" id="dependents" value="1" min="1">
        <span class="warning" id="warningDependents"></span><br>

        <label for="childrenUnder20">20세 이하 부양 자녀수:</label>
        <input type="number" id="childrenUnder20" value="0" min="0">
        <span class="warning" id="warningChildrenUnder20"></span><br>

        <button onclick="calculateTax()">계산하기</button>
        <h3>계산된 간이세액: <span id="taxResult">0</span>원</h3>
    </div>

    <style>
    .warning {
        color: red;
        display: none;
        font-size: 0.8em;
    }
    </style>

    <script>
        let taxTable = []; // 전역 변수로 세금 테이블을 저장

        // 페이지 로드 시 엑셀 파일 로드
        window.onload = function() {
            fetch('earned_income_withholding_tax_rates_2024.xlsx', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                },
            })
            .then(response => response.arrayBuffer())
            .then(data => {
                const workbook = XLSX.read(data, {type: 'buffer'});
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                taxTable = json.slice(1); // 첫 번째 행(제목 행)을 제외하고 데이터 저장
            })
            .catch(error => console.error('Error loading the file:', error));
        };
        
        function showWarning(inputId, message) {
            const warningId = 'warning' + inputId.charAt(0).toUpperCase() + inputId.slice(1);
            const warningElement = document.getElementById(warningId);
            warningElement.style.display = 'inline';
            warningElement.textContent = message;
        }

        function hideWarnings() {
            const warningElements = document.getElementsByClassName('warning');
            for (let element of warningElements) {
                element.style.display = 'none';
            }
        }

        function calculateTax() {
            hideWarnings(); // 숨기기 경고

            const preTaxIncomeElement = document.getElementById('preTaxIncome');
            const nonTaxableAmountElement = document.getElementById('nonTaxableAmount');
            const dependentsElement = document.getElementById('dependents');
            const childrenUnder20Element = document.getElementById('childrenUnder20');

            const preTaxIncome = preTaxIncomeElement.value * 10000;
            const nonTaxableAmount = nonTaxableAmountElement.value * 10000;
            const dependents = dependentsElement.value;
            const childrenUnder20 = childrenUnder20Element.value;

            // 입력 값 검증
            if(preTaxIncome < preTaxIncomeElement.min * 10000) {
                showWarning('preTaxIncome', '세전 월급의 최소값은 ' + preTaxIncomeElement.min + '만원입니다.');
                preTaxIncome = preTaxIncomeElement.min * 10000
                document.getElementById('preTaxIncome').value = preTaxIncome;
            }
            if(nonTaxableAmount < nonTaxableAmountElement.min * 10000) {
                showWarning('nonTaxableAmount', '비과세액의 최소값은 ' + nonTaxableAmountElement.min + '만원입니다.');
                nonTaxableAmount = nonTaxableAmountElement.min * 10000
                document.getElementById('nonTaxableAmount').value = nonTaxableAmount
            }
            if(dependents < dependentsElement.min) {
                showWarning('dependents', '부양 가족 수의 최소값은 ' + dependentsElement.min + '명입니다.');
                dependents = dependentsElement.min
                document.getElementById('dependents').value = dependents
            }
            if(childrenUnder20 < childrenUnder20Element.min) {
                showWarning('childrenUnder20', '20세 이하 부양 자녀수의 최소값은 ' + childrenUnder20Element.min + '명입니다.');
                childrenUnder20 = childrenUnder20Element.min
                document.getElementById('childrenUnder20').value = childrenUnder20
            }

            const taxableIncome = (preTaxIncome - nonTaxableAmount) / 1000;
            const totalDependents = dependents + childrenUnder20;

            console.log(taxTable); // taxTable 데이터 확인
            console.log(`Taxable Income: ${taxableIncome}, Total Dependents: ${totalDependents}`); // 입력 확인

            let taxAmount = 0;

            for (let row of taxTable) {
                console.log(`Row: ${row}`); // 현재 행 데이터 확인
                if (taxableIncome >= row[0] && taxableIncome < row[1]) {
                    const index = totalDependents + 1;
                    console.log(`Applicable Tax Rate: ${row[index]}`); // 적용 세율 확인
                    taxAmount = row[index] ? row[index] : 0;
                    break;
                }
            }

            console.log(`Tax Amount: ${taxAmount}`); // 계산된 세액 확인
            document.getElementById('taxResult').textContent = taxAmount.toFixed(0);
        }
    </script>
</body>
</html>
